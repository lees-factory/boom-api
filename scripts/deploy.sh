#!/bin/bash

# =======================================
# Î≥ÄÏàò ÏÑ§Ï†ï
# =======================================
APP_NAME="core-api"
DEPLOY_PATH="/home/ubuntu/boom-api"
ACTIVE_PROFILE="live" # prod ÌôòÍ≤ΩÏù¥ÎØÄÎ°ú live

echo "======================================="
echo "   üöÄ Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ: $APP_NAME"
echo "======================================="

# ---------------------------------------
# 1. JAR ÌååÏùº Ï∞æÍ∏∞ (ÏûêÎèô Í∞êÏßÄ)
# ---------------------------------------
echo "> 1. JAR ÌååÏùº ÌÉêÏÉâ Ï§ë..."

# boom-api Ìè¥Îçî ÎÇ¥Ïùò Î™®Îì† .jar ÌååÏùºÏùÑ Ï∞æÎêò, plain.jar(ÍªçÎç∞Í∏∞)Îäî Ï†úÏô∏ÌïòÍ≥† Í∞ÄÏû• ÏµúÏã† ÌååÏùº 1Í∞ú ÏÑ†ÌÉù
JAR_PATH=$(find $DEPLOY_PATH -name "*.jar" ! -name "*plain.jar" | head -n 1)

if [ -z "$JAR_PATH" ]; then
  echo "‚ùå Ïò§Î•ò: Ïã§ÌñâÌï† JAR ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
  echo "   ÌòÑÏû¨ Í≤ΩÎ°ú: $DEPLOY_PATH"
  echo "   ÌååÏùº Î™©Î°ù:"
  ls -R $DEPLOY_PATH
  exit 1
fi

echo "   > Ï∞æÏùÄ JAR ÌååÏùº: $JAR_PATH"

# ---------------------------------------
# 2. Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
# ---------------------------------------
echo "> 2. Íµ¨Îèô Ï§ëÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÌôïÏù∏ Î∞è Ï¢ÖÎ£å"
CURRENT_PID=$(pgrep -f "java -jar.*$APP_NAME")

if [ -z "$CURRENT_PID" ]; then
    echo "   > Íµ¨Îèô Ï§ëÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§."
else
    echo "   > Ïã§Ìñâ Ï§ëÏù∏ ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å (PID: $CURRENT_PID)"
    kill -15 $CURRENT_PID
    sleep 5
fi

# ---------------------------------------
# 3. ÏÉà Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïã§Ìñâ
# ---------------------------------------
echo "> 3. ÏÉà Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïã§Ìñâ"

chmod +x $JAR_PATH

# DB ÎπÑÎ∞ÄÎ≤àÌò∏ Îì±ÏùÄ ÌôòÍ≤ΩÎ≥ÄÏàò(-D)ÎÇò OS ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï£ºÏûÖÎê®
nohup java -jar \
    -Dspring.profiles.active=$ACTIVE_PROFILE \
    -Dstorage.database.core-db.password="${DB_PASSWORD}" \
    $JAR_PATH > $DEPLOY_PATH/nohup.out 2>&1 &

echo "======================================="
echo "   ‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å! (Î°úÍ∑∏: $DEPLOY_PATH/nohup.out)"
echo "======================================="
